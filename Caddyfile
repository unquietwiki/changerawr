# Caddyfile for Changerawr with on-demand TLS
# Caddy automatically obtains and renews Let's Encrypt certificates

{
    # Global options
    email {$ACME_EMAIL}

    # Enable on-demand TLS with ask endpoint
    on_demand_tls {
        ask http://app:3000/api/domain-check
    }
}

# Catch-all for custom domains
:80, :443 {
    # Enable on-demand TLS for all incoming requests
    tls {
        on_demand
    }

    # Reverse proxy all requests to the Next.js app
    reverse_proxy app:3000 {
        # Pass original host header
        header_up Host {host}

        # Pass real IP and protocol
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
    }

    # Enable compression
    encode gzip

    # Logging
    log {
        output stdout
        format console
    }
}
